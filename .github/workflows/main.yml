steps:
  # 1️⃣ Checkout repository
  - name: Checkout code
    uses: actions/checkout@v3

  # 2️⃣ Set up Docker Buildx
  - name: Set up Docker Buildx
    uses: docker/setup-buildx-action@v2

  # 3️⃣ Login to Docker Hub
  - name: Docker Hub Login
    uses: docker/login-action@v2
    with:
      username: ${{ secrets.DOCKER_USERNAME }}
      password: ${{ secrets.DOCKER_PASSWORD }}

  # 4️⃣ Build + Push Frontend Image (Ensure your local Dockerfile for front-end is correct)
  - name: Build and push Frontend Docker image
    run: |
      docker build -t muzaffaribrar/ems-system:frontend ./front-end
      docker push muzaffaribrar/ems-system:frontend

  # 5️⃣ Build + Push Backend Image (The remote image will still have the underlying entrypoint issue)
  - name: Build and push Backend Docker image
    run: |
      docker build -t muzaffaribrar/ems-system:backend ./Backend
      docker push muzaffaribrar/ems-system:backend

  # 6️⃣ Deploy on EC2
  - name: Deploy to EC2
    run: |
      # Save PEM key
      echo "${{ secrets.EC2_PEM }}" > key.pem
      chmod 600 key.pem

      # Copy the corrected docker-compose.yml (with the 'command' override)
      scp -o StrictHostKeyChecking=no -i key.pem docker-compose/docker-compose.yml ubuntu@18.218.243.84:/home/ubuntu/my-project/docker-compose.yml

      # Use 'read -r' for safe multiline SSH input
      # Pass secret into the environment of the SSH session
      
      ssh -o StrictHostKeyChecking=no -i key.pem ubuntu@18.218.243.84 MONGO_URI_VALUE="${{ secrets.MONGO_URI }}" << 'EOF'
        cd /home/ubuntu/my-project

        # Use the environment variable passed from the GH Action runner
        echo "Updating .env file with MONGO_URI..."
        echo "MONGO_URI=$MONGO_URI_VALUE" > .env
        chmod 600 .env

        echo "Pulling latest Docker images..."
        # Pull is good practice, but 'docker-compose up' will also pull if a new image exists.
        docker pull muzaffaribrar/ems-system:frontend
        docker pull muzaffaribrar/ems-system:backend

        echo "Starting services using docker-compose..."
        # Use --force-recreate to ensure the new 'command' instruction is applied
        docker-compose up -d --remove-orphans --force-recreate
      EOF
